---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
theme_set(theme_classic())
```

```{r}
# 1579686732242
character_ids <- read_tsv("../data/cards.csv") %>% filter(did == 1550758092309) %>% dplyr::select(card_id=id, notes_id=nid)
notes_df <- read_tsv("../data/notes.tsv") %>% mutate(notes_id=id)

character_ids_w_char <- character_ids %>% 
    dplyr::inner_join(notes_df, by="notes_id") %>% 
    dplyr::select(card_id, notes_id, character=sfld)
head(character_ids_w_char)

revlog_df <- read_tsv("../data/revlog.csv") %>% 
    dplyr::rename(card_id=cid) %>% 
    filter(card_id %in% character_ids_w_char$card_id) %>%
    inner_join(character_ids_w_char %>% dplyr::select(card_id, character), by="card_id") %>%
    mutate(duration=ifelse(lastIvl < 0, -lastIvl/3600/24, lastIvl))

revlog_df_w_nbr <- revlog_df %>% 
    group_by(card_id) %>% 
    group_map(~.x %>% mutate(nbr=seq_len(n())), keep = TRUE) %>% 
    do.call("rbind", .)

top_difficult_cards <- revlog_df_w_nbr %>% 
    group_by(card_id) %>% 
    summarize(
        reviews=length(id), 
        curr_dur=tail(lastIvl, 1), 
        curr_ease=sprintf("ease_%s", tail(ease, 1)),
        avg_ease=mean(ease)
    ) %>% 
    mutate(curr_dur=ifelse(curr_dur<0, 0, curr_dur)) %>%
    arrange(desc(reviews))

top_difficult_df <- top_difficult_cards %>% inner_join(character_ids_w_char, by="card_id")
write_tsv(top_difficult_df, path = "../parsed_data/top_difficult.tsv")
write_tsv(revlog_df_w_nbr, path = "../parsed_data/all_reviews.tsv")



# notes_df <- read_tsv("../data/notes.tsv") %>% mutate(id=as.character(id))
# table(notes_df$id %in% character_ids)
```

# Investigating progress

```{r}
#top_difficult_cards[5, ]
#top_difficult_cards[2, ]$card_id

top_difficult_df <- revlog_df %>% 
    filter(cid %in% top_difficult_cards[5, ]$card_id) %>% 
    mutate(nbr=seq_len(n()))
top_difficult_df %>% ggplot(aes(x=ease)) + geom_histogram()

head(top_card_reviews)

top_card_reviews %>% 
    mutate(duration=ifelse(lastIvl < 0, -lastIvl/3600/24, lastIvl)) %>% 
    #filter(lastIvl > 0) %>% 
    ggplot(aes(x=nbr, y=duration)) + geom_line() + geom_point(aes(color=as.factor(ease)), size=3)
```


# Getting recently failed

```{r}
revlog_df %>% filter(type==1 & ease==1) %>% tail()

ms_to_date = function(ms, t0="1970-01-01", timezone) {
        ## @ms: a numeric vector of milliseconds (big integers of 13 digits)
        ## @t0: a string of the format "yyyy-mm-dd", specifying the date that
        ##      corresponds to 0 millisecond
        ## @timezone: a string specifying a timezone that can be recognized by R
        ## return: a POSIXct vector representing calendar dates and times        
        sec = ms / 1000
        as.POSIXct(sec, origin=t0, tz=timezone)
}

revlog_df$id[1]

sec <- tail(revlog_df, 1)$id[1] / 1000
sec
as.POSIXct(sec, origin="1970-01-01")
# ms_to_date(revlog_df$id[1] %>% as.numeric(), "GMT")

# SUCCESS!

?as.POSIXct
```











